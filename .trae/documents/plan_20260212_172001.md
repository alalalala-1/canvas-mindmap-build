## 稳健重构方案

### 原则
- 不改变项目执行效果和功能
- 每次修改后验证构建和测试
- 小步迭代，每次提交可独立验证

---

### 阶段一：安全修复（高优先级）

**1.1 修复非空断言风险**
- `layout.ts:562-565` - 添加空值检查，避免运行时崩溃

**1.2 修复无限递归风险**
- `collapse-state.ts:84-92` - 在 `addAllDescendantsToSet` 入口添加已存在检查

**1.3 修复内存泄漏**
- `layout-manager.ts:148,155-156` - 管理 setTimeout 返回值
- `canvas-event-manager.ts` 多处 - 统一 setTimeout 管理

---

### 阶段二：代码质量改进（中优先级）

**2.1 统一错误处理**
- 扩展 `error-handler.ts` 使用范围
- 确保所有异步操作有适当的错误处理

**2.2 提取硬编码值**
- 时间延迟值移至 `constants.ts`
- 默认尺寸值移至 `constants.ts`

**2.3 消除代码重复**
- 边端点解析逻辑统一使用 `canvas-utils.ts`
- 节点/边获取逻辑统一使用工具函数

---

### 阶段三：持续改进（低优先级）

**3.1 拆分过长函数**
- `layout-manager.ts` 中的大函数拆分
- `floating-node-service.ts` 中的 `reapplyAllFloatingStyles` 拆分

**3.2 类型安全改进**
- 扩展 Obsidian 事件类型定义
- 减少 `types.ts` 中可选属性的使用

---

### 执行策略

1. 每个阶段独立提交
2. 每次修改后运行 `npm run build` 验证
3. 优先处理安全风险，再处理代码质量
4. 避免大规模重构，保持小步迭代

---

### 预期效果

| 指标 | 当前 | 目标 |
|------|------|------|
| 非空断言风险 | 3处 | 0处 |
| 未管理的定时器 | 8处 | 0处 |
| 硬编码值 | 12+处 | 0处 |
| 代码重复 | 5类 | 0处 |