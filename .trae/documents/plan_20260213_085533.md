# Canvas Mindmap Build 渐进式重构方案

## 一、重构原则

1. **保持稳定**: 不改变现有功能行为
2. **小步迭代**: 每次改动小，易于验证
3. **向后兼容**: 不破坏现有接口
4. **渐进优化**: 优先解决痛点问题

---

## 二、重构内容

### 2.1 类型定义完善（低风险）

**目标**: 减少 `any` 使用，提高类型安全性

**改动**:
- 在 `types.ts` 中补充缺失的类型定义
- 为关键函数添加返回类型注解
- 不改变运行时行为

**示例**:
```typescript
// 为 LayoutNode 添加完整类型
interface LayoutNode {
    id: string;
    x: number;
    y: number;
    width: number;
    height: number;
    children: string[];
    _subtreeHeight: number;
    originalParent?: string;
}
```

---

### 2.2 常量提取（低风险）

**目标**: 消除魔法数字，提高可读性

**改动**:
- 将散落的数字提取到 `constants.ts`
- 不改变运行时行为

**示例**:
```typescript
// 添加到 constants.ts
export const LAYOUT = {
    DEFAULT_NODE_WIDTH: 250,
    DEFAULT_NODE_HEIGHT: 100,
    HEIGHT_TOLERANCE: 4,  // 高度容差
    MIN_NODE_HEIGHT: 60,
} as const;
```

---

### 2.3 函数拆分（低风险）

**目标**: 提高可读性，不改变逻辑

**改动**:
- 将过长函数拆分为多个小函数
- 保持函数签名不变
- 保持调用方式不变

**示例 - layout.ts**:
```typescript
// 拆分前: arrangeLayout 函数 641行
// 拆分后: 保持 arrangeLayout 入口不变，内部调用多个小函数

export function arrangeLayout(...) {
    const context = prepareLayoutContext(nodes, edges, settings, canvasData);
    calculateLayout(context);
    return buildResult(context);
}
```

---

### 2.4 错误处理统一（低风险）

**目标**: 统一错误处理方式

**改动**:
- 扩展现有 `error-handler.ts`
- 统一日志格式
- 不改变异常抛出行为

---

### 2.5 注释完善（无风险）

**目标**: 提高代码可读性

**改动**:
- 为关键函数添加 JSDoc 注释
- 为复杂逻辑添加行内注释
- 纯文档改动

---

## 三、不做的事项

1. ❌ 不引入新的架构模式（依赖注入、事件总线等）
2. ❌ 不拆分大文件（保持现有文件结构）
3. ❌ 不改变服务初始化方式
4. ❌ 不修改核心算法逻辑
5. ❌ 不改变现有接口签名

---

## 四、实施步骤

### 第1步：类型完善（1天）
- 补充 `types.ts` 中的类型定义
- 为关键函数添加类型注解

### 第2步：常量提取（半天）
- 识别魔法数字
- 提取到 `constants.ts`

### 第3步：注释完善（1天）
- 为关键函数添加 JSDoc
- 为复杂逻辑添加说明

### 第4步：函数拆分（2天）
- 拆分过长函数
- 保持接口不变

### 第5步：错误处理（半天）
- 统一错误日志格式

---

## 五、预期收益

| 改动     | 收益          | 风险 |
| -------- | ------------- | ---- |
| 类型完善  | 提高类型安全性  | 无   |
| 常量提取  | 提高可读性     | 无   |
| 注释完善  | 提高可维护性   | 无   |
| 函数拆分  | 提高可读性     | 低   |
| 错误处理  | 统一调试体验   | 无   |

---

## 六、验证方式

1. 每次改动后运行 `npm run build` 确保编译通过
2. 运行 `npm run lint` 确保代码规范
3. 手动测试核心功能：
   - 添加节点
   - 布局整理
   - 折叠/展开
   - 浮动节点

