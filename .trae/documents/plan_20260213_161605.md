## 项目架构分析报告

### 当前架构概览
```
main.ts
  └── CanvasManager (核心管理器)
        ├── CanvasEventManager (事件处理)
        ├── CanvasNodeManager (节点管理)
        ├── CanvasUIManager (UI 管理)
        ├── LayoutManager (布局管理)
        ├── FloatingNodeService (浮动节点)
        │     ├── FloatingNodeStateManager
        │     ├── FloatingNodeStyleManager
        │     └── EdgeChangeDetector
        ├── EdgeDeletionService (边删除)
        ├── NodeDeletionService (节点删除)
        ├── NodeCreationService (节点创建)
        ├── VisibilityService (可见性)
        ├── LayoutDataProvider (布局数据)
        └── CanvasFileService (文件服务) ⚠️ 被重复创建
```

---

### 发现的问题

#### 1. 服务实例重复创建 (严重)
- `CanvasFileService` 被创建了 **3 次**（FloatingNodeService、CanvasManager、CanvasEventManager）
- 这导致文件操作不同步，可能造成数据丢失

**建议**：使用单例模式或依赖注入

#### 2. 文件保存调用分散 (中等)
- `canvas.requestSave()` 被调用了 **12 次**在多个地方
- 没有统一的保存策略，可能导致频繁/重复保存

**建议**：统一通过 CanvasFileService 管理保存

#### 3. FloatingNodeService 过于庞大 (中等)
- 同时处理：状态管理、样式管理、边检测
- 内部创建了 CanvasFileService、EdgeChangeDetector

**建议**：拆分为更小的服务

#### 4. 类型定义不完善 (轻微)
- 148 个 Lint 错误，主要是 `any` 类型

---

### 建议的重构优先级

| 优先级 | 任务 | 影响 |
|--------|------|------|
| **P0** | 统一 CanvasFileService 实例 | 防止数据丢失 |
| **P1** | 统一文件保存策略 | 减少重复保存 |
| **P2** | 拆分 FloatingNodeService | 代码可维护性 |
| **P3** | 完善类型定义 | 代码质量 |