# Canvas Mindmap Build for Obsidian

一个功能强大的 Obsidian 插件，用于在 Canvas 画布中构建和管理思维导图，支持自动布局、节点折叠、浮动节点管理等功能。

## 需求说明

### 目标与范围
- 在 Obsidian Canvas 中以节点和连线的形式快速构建思维导图
- 支持从 Markdown 选区生成节点，并与源文件建立跳转关系
- 支持节点折叠、自动布局、浮动节点识别与恢复
- 仅在本地工作，不依赖网络服务

### 功能需求
- 选中文本/图片/公式后，通过 **Add to Canvas Mindmap** 命令写入目标 Canvas（路径由设置指定）
- 节点类型：文本、图片、公式；公式以 `$$...$$` 识别，图片支持 `![[...]]` 与 `![...](...)`
- 节点尺寸按类型区分：文本自动高度、公式固定尺寸、图片使用预设尺寸
- 写入 `fromLink`（文本节点写入 `<!-- fromLink:... -->`，非文本写入 `node.color`），点击节点跳转回源文件选区
- 自动为有子节点的节点渲染折叠按钮；无子节点时移除按钮并清理折叠状态
- 折叠/展开需隐藏/恢复子树与相关边，并触发布局刷新
- 删除节点弹出确认对话框：**仅删除节点** 自动重连父子、**级联删除** 删除整棵子树
- 删除边弹出确认对话框；失去入边的节点标记为浮动节点并记录 `originalParent`
- 浮动节点红框提示；新入边创建后清除浮动状态与红框
- 提供命令入口：新增节点、布局整理、删除边、批量调整高度
- 设置页支持配置节点尺寸、间距、折叠按钮颜色与调试日志开关

### 非功能需求
- 性能：避免在 onload 期间执行重型布局，布局与 DOM 监听需防抖
- 可靠性：文件写入必须原子化，防止并发覆盖
- 兼容性：支持 Obsidian 0.15+，移动端可用
- 可维护性：模块职责清晰，核心逻辑集中在 services/manager
- 隐私与安全：不采集任何数据，不执行远程代码

### 约束与依赖
- 运行环境：Node.js 18+，Obsidian Canvas
- 构建工具：npm + esbuild
- 插件资产：main.js、manifest.json、styles.css

## 功能特性

### 📝 节点管理

#### 添加节点到 Canvas
- 在 Markdown 编辑器中选中文字或图片
- 运行命令 `Add to Canvas Mindmap`
- 自动将选中的内容作为节点添加到 Canvas
- 支持文本节点、图片节点和公式节点
- 自动检测公式内容（`$$...$$`）并应用公式节点尺寸
- 自动记录节点与源文件的链接关系（fromLink）

#### 节点高度自适应
- 文本节点高度根据内容自动调整
- 公式节点使用固定高度配置
- 图片节点使用预设尺寸
- 新节点添加后自动调整高度
- 支持批量调整所有文本节点高度

#### 节点删除确认
- 删除节点时弹出确认对话框
- 提供三种删除选项：
  - **取消**：不执行删除操作
  - **仅删除节点**：删除当前节点，子节点自动连接到父节点
  - **级联删除**：删除当前节点及其所有子节点

### 🔗 边（连线）管理

#### 边删除确认
- 删除连线时弹出确认对话框
- 防止误操作删除重要连接

#### 从链接跳转
- 点击 Canvas 节点可跳转到源文件
- 自动记录节点与源文件的链接关系
- 支持文本节点和图片节点的链接跳转

### 📐 节点折叠/展开

- 自动为有子节点的父节点添加折叠按钮
- 点击按钮可折叠/展开子节点
- 支持多级节点的递归折叠/展开
- 折叠/展开时自动重新布局可见节点，保持合理的间距
- 折叠按钮颜色可自定义
- 折叠状态持久化保存

### 🎯 浮动节点管理

- **浮动节点检测**：删除连线后，失去入边的节点自动标记为浮动状态
- **红框标识**：浮动节点显示红色边框，便于识别
- **状态持久化**：浮动状态保存在节点数据中，刷新后保持
- **自动恢复**：重新连接入边后，自动清除浮动状态和红框
- **布局参与**：浮动节点参与布局计算，保持与原父节点的虚拟连接
- **子树支持**：浮动节点的子节点也参与布局，形成完整的浮动子树

### 🎨 自动布局

- **树形布局算法**：从左到右的层级布局
- **智能间距**：可配置水平和垂直间距
- **浮动节点处理**：浮动节点在布局时保持与原父节点的相对位置
- **防抖优化**：避免频繁布局计算
- **命令触发**：运行 `Arrange Canvas Mindmap Layout` 命令手动触发布局

## 使用方法

### 1. 配置目标 Canvas 文件
1. 打开 Obsidian 设置
2. 进入插件设置 → Canvas Mindmap
3. 设置目标 Canvas 文件路径（相对于保险库根目录）

### 2. 添加节点
1. 在 Markdown 文件中选中文字或图片
2. 使用命令面板（Ctrl/Cmd + P）运行 `Add to Canvas Mindmap`
3. 新节点将自动添加到 Canvas 中

### 3. 折叠/展开节点
- 节点右侧会自动显示折叠按钮（红色）
- 点击按钮可展开/折叠子节点
- 按钮状态：红色实心=已折叠，红色边框=已展开

### 4. 整理布局
- 使用命令面板运行 `Arrange Canvas Mindmap Layout`
- 或使用快捷键触发自动布局

### 5. 删除节点/连线
- 选中节点或连线后点击删除按钮
- 在弹出的对话框中选择删除方式

## 设置选项

| 设置项 | 说明 | 默认值 |
|-------|------|-------|
| Target Canvas File | 目标 Canvas 文件路径 | - |
| Enable Text Auto Size | 启用文本节点高度自适应 | true |
| Text Node Width | 文本节点宽度 | 400 |
| Text Node Max Height | 文本节点最大高度 | 800 |
| Image Node Width | 图片节点宽度 | 400 |
| Image Node Height | 图片节点高度 | 400 |
| Enable Formula Detection | 启用公式检测 | true |
| Formula Node Width | 公式节点宽度 | 400 |
| Formula Node Height | 公式节点高度 | 80 |
| Horizontal Spacing | 水平间距（父子节点） | 200 |
| Vertical Spacing | 垂直间距（兄弟节点） | 40 |
| Collapse Button Color | 折叠按钮颜色 | #e74c3c |
| Enable Debug Logging | 启用调试日志 | false |

## 命令列表

| 命令 ID | 名称 | 说明 |
|---------|------|------|
| `add-to-canvas-mindmap` | Add to Canvas Mindmap | 将选中内容添加到 Canvas |
| `arrange-canvas-mindmap-layout` | Arrange Canvas Mindmap Layout | 整理 Canvas 布局 |
| `delete-selected-edge` | Delete Selected Edge | 删除选中的连线 |
| `adjust-all-text-node-heights` | Adjust All Text Node Heights | 调整所有文本节点高度 |

## 安装

### 手动安装
1. 将 `main.js`、`manifest.json`、`styles.css` 复制到 `<保险库>/.obsidian/plugins/canvas-mindmap-build/`
2. 在 Obsidian 设置中启用插件

### 社区插件
通过 Obsidian 设置 → 社区插件 → 浏览搜索 "Canvas Mindmap"

## 系统要求

- Obsidian v0.15.0+
- 支持 macOS、iOS、Android

## 技术说明

- 使用 TypeScript 开发
- 无外部运行时依赖
- 纯本地操作，不收集任何数据
- 模块化架构，职责分离

## 更新日志

### v1.2.0
- 新增浮动节点管理功能（红框标识、状态持久化）
- 新增边删除确认对话框
- 优化布局算法，支持浮动节点虚拟连接
- 修复布局保存时边丢失的问题
- 修复级联删除路径获取问题
- 优化日志系统，减少冗余输出
- 修复浮动节点样式在 DOM 重绘后丢失的问题
- 修复连线需两次才能成功的问题

### v1.1.0
- 新增节点删除确认对话框（支持单节点/级联删除）
- 新增节点高度自适应功能
- 优化折叠/展开后的自动布局
- 改进公式节点检测

### v1.0.0
- 初始版本
- 添加节点到 Canvas 功能
- 节点折叠/展开功能
- 从链接跳转功能
