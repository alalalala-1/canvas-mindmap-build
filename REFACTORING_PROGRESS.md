# Canvas Mindmap Build - é‡æ„è¿›åº¦æ–‡æ¡£

## é‡æ„ç›®æ ‡
å°† `canvas-manager.ts` ä¸­çš„åŠŸèƒ½æ‹†åˆ†åˆ°å¤šä¸ªä¸“é—¨çš„ Manager ç±»ä¸­ï¼Œæé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯æµ‹è¯•æ€§ã€‚

---

## é‡æ„è¿›åº¦

### âœ… å·²å®Œæˆ

#### 1. CanvasEventManager (canvas-event-manager.ts)
- **çŠ¶æ€**: å·²å®Œæˆ âœ…
- **èŒè´£**: å¤„ç†æ‰€æœ‰ Canvas ç›¸å…³çš„äº‹ä»¶ç›‘å¬å’Œå“åº”
- **ä¸»è¦åŠŸèƒ½**:
  - ç›‘å¬ `canvas:edge-created` äº‹ä»¶
  - ç›‘å¬ `canvas:edge-removed` äº‹ä»¶
  - ç›‘å¬ `canvas:node-moved` äº‹ä»¶
  - ä½¿ç”¨ MutationObserver ç›‘å¬ DOM å˜åŒ–
  - å¤„ç†æŠ˜å æŒ‰é’®ç‚¹å‡»äº‹ä»¶
- **ä»£ç è¡Œæ•°**: ~841 è¡Œ

#### 2. FloatingNodeService (floating-node-service.ts)
- **çŠ¶æ€**: å·²å®Œæˆ âœ…
- **èŒè´£**: ç®¡ç†æµ®åŠ¨èŠ‚ç‚¹çš„çŠ¶æ€å’Œä¸šåŠ¡é€»è¾‘
- **ä¸»è¦åŠŸèƒ½**:
  - æ ‡è®°èŠ‚ç‚¹ä¸ºæµ®åŠ¨çŠ¶æ€
  - æ¸…é™¤æµ®åŠ¨èŠ‚ç‚¹çŠ¶æ€
  - åè°ƒæ ·å¼ç®¡ç†å’ŒçŠ¶æ€æŒä¹…åŒ–
  - éªŒè¯æµ®åŠ¨èŠ‚ç‚¹çš„æœ‰æ•ˆæ€§
- **æœ€è¿‘ä¿®å¤ä¸æ”¹è¿›**:
  - **çº¢æ¡†å¯è§æ€§**: å¼•å…¥ `MutationObserver` å’Œå»¶è¿Ÿé‡è¯•æœºåˆ¶ï¼Œç¡®ä¿ Obsidian é‡ç»˜åçº¢æ¡†æ ·å¼ä¸ä¸¢å¤±ã€‚
  - **è¿çº¿å†²çªä¿®å¤**: ç§»é™¤äº†å†—ä½™çš„åŸå­åŒ–æ–‡ä»¶å†™å…¥ï¼Œä¼˜å…ˆä½¿ç”¨å†…å­˜çŠ¶æ€å¹¶å§”æ‰˜ Obsidian åŸç”Ÿä¿å­˜ï¼Œè§£å†³â€œè¿çº¿éœ€ä¸¤æ¬¡â€çš„é—®é¢˜ã€‚
  - **å³æ—¶æ ·å¼æ¸…é™¤**: å¢åŠ  `edge-add` äº‹ä»¶ç›‘å¬ï¼Œç¡®ä¿é‡æ–°è¿çº¿åçº¢æ¡†ç«‹å³æ¶ˆå¤±ã€‚
  - **æ¶æ„è§£è€¦**: æå– `FloatingNodeStyleManager` è´Ÿè´£è§†è§‰è¡¨ç°ï¼Œ`FloatingNodeStateManager` è´Ÿè´£æŒä¹…åŒ–ã€‚

#### 3. FloatingNodeStyleManager (floating-node-style-manager.ts)
- **çŠ¶æ€**: å·²å®Œæˆ âœ…
- **èŒè´£**: è´Ÿè´£æµ®åŠ¨èŠ‚ç‚¹çš„è§†è§‰å‘ˆç°ï¼ˆçº¢æ¡†æ ·å¼ï¼‰
- **ä¸»è¦åŠŸèƒ½**:
  - åº”ç”¨/æ¸…é™¤ `cmb-floating-node` æ ·å¼ç±»
  - å»¶è¿Ÿé‡è¯•åº”ç”¨æ ·å¼ï¼ˆè§£å†³ DOM å°šæœªå°±ç»ªé—®é¢˜ï¼‰
  - ä½¿ç”¨ `!important` ç¡®ä¿æ ·å¼ä¼˜å…ˆçº§
  - å¼ºåˆ¶ DOM é‡ç»˜ä»¥ä¿è¯å³æ—¶ç”Ÿæ•ˆ

#### 4. EdgeChangeDetector (edge-change-detector.ts)
- **çŠ¶æ€**: å·²å®Œæˆ âœ…
- **èŒè´£**: æŒç»­æ£€æµ‹ Canvas ä¸­è¾¹çš„å˜åŒ–
- **ä¸»è¦åŠŸèƒ½**:
  - è½®è¯¢æ£€æµ‹æ–°å¢è¾¹ï¼ˆæ”¯æŒæŒç»­æ£€æµ‹æ¨¡å¼ï¼‰
  - è¯†åˆ«å¹¶è§¦å‘æ–°è¾¹è¿æ¥çš„å›è°ƒ
  - è¾…åŠ©å¤„ç†æµ®åŠ¨çŠ¶æ€çš„è‡ªåŠ¨æ¸…ç†

#### 5. CanvasManager (canvas-manager.ts)
- **çŠ¶æ€**: å·²å®Œæˆ âœ…
- **èŒè´£**: åè°ƒå„ä¸ª Managerï¼Œæä¾›ç»Ÿä¸€çš„æ¥å£
- **ä¸»è¦åŠŸèƒ½**:
  - åˆå§‹åŒ–æ‰€æœ‰ Manager
  - æä¾›ç»Ÿä¸€çš„ Canvas æ“ä½œæ¥å£
  - å¤„ç†æ’ä»¶ç”Ÿå‘½å‘¨æœŸäº‹ä»¶

---

### ğŸ”„ è¿›è¡Œä¸­

#### 4. LayoutManager (layout-manager.ts)
- **çŠ¶æ€**: è¿›è¡Œä¸­ ğŸ”„
- **èŒè´£**: å¤„ç†æ‰€æœ‰å¸ƒå±€ç›¸å…³çš„åŠŸèƒ½
- **ä¸»è¦åŠŸèƒ½**:
  - æ‰§è¡Œ Canvas å¸ƒå±€ (arrangeCanvas)
  - æŠ˜å /å±•å¼€åçš„è‡ªåŠ¨å¸ƒå±€ (autoArrangeAfterToggle)
  - èŠ‚ç‚¹é«˜åº¦è°ƒæ•´
  - æµ®åŠ¨èŠ‚ç‚¹å¸ƒå±€å¤„ç†
- **ä»£ç è¡Œæ•°**: ~863 è¡Œ
- **å¾…å®Œæˆ**:
  - è¿›ä¸€æ­¥ä¼˜åŒ–å¸ƒå±€ç®—æ³•
  - æå–å¸ƒå±€ç›¸å…³çš„å·¥å…·å‡½æ•°åˆ°å•ç‹¬æ–‡ä»¶
  - è€ƒè™‘å°†å¸ƒå±€ç®—æ³•ä¸å¸ƒå±€ç®¡ç†åˆ†ç¦»

---

### â³ å¾…å¼€å§‹

#### 5. CanvasNodeManager (canvas-node-manager.ts)
- **çŠ¶æ€**: å¾…å¼€å§‹ â³
- **èŒè´£**: å¤„ç†èŠ‚ç‚¹çš„åˆ›å»ºå’Œç®¡ç†
- **ä¸»è¦åŠŸèƒ½**:
  - æ·»åŠ èŠ‚ç‚¹åˆ° Canvas
  - åˆ›å»ºæ–°èŠ‚ç‚¹
  - èŠ‚ç‚¹å†…å®¹å¤„ç†
- **ä»£ç è¡Œæ•°**: ~533 è¡Œ
- **è®¡åˆ’**:
  - æå–èŠ‚ç‚¹åˆ›å»ºé€»è¾‘
  - ä¼˜åŒ–èŠ‚ç‚¹å†…å®¹å¤„ç†
  - ä¸ CanvasUIManager åè°ƒ

#### 6. CanvasUIManager (canvas-ui-manager.ts)
- **çŠ¶æ€**: å¾…å¼€å§‹ â³
- **èŒè´£**: å¤„ç† UI ç›¸å…³çš„åŠŸèƒ½
- **ä¸»è¦åŠŸèƒ½**:
  - æŠ˜å æŒ‰é’®çš„åˆ›å»ºå’Œç®¡ç†
  - æ§åˆ¶é¢æ¿çš„æ˜¾ç¤º
  - UI çŠ¶æ€ç®¡ç†
- **ä»£ç è¡Œæ•°**: ~338 è¡Œ
- **è®¡åˆ’**:
  - æå–æŠ˜å æŒ‰é’®é€»è¾‘
  - ä¼˜åŒ– UI æ›´æ–°æœºåˆ¶
  - è€ƒè™‘ä½¿ç”¨æ›´ç°ä»£çš„ UI æ¡†æ¶

#### 7. EdgeManager (edge-manager.ts)
- **çŠ¶æ€**: å¾…è¯„ä¼° â³
- **èŒè´£**: å¤„ç†è¾¹çš„åˆ›å»ºå’Œç®¡ç†
- **ä»£ç è¡Œæ•°**: ~335 è¡Œ
- **è¯„ä¼°**:
  - æ˜¯å¦éœ€è¦ç‹¬ç«‹é‡æ„
  - è¿˜æ˜¯åˆå¹¶åˆ° CanvasEventManager

#### 8. NodeManager (node-manager.ts)
- **çŠ¶æ€**: å¾…è¯„ä¼° â³
- **èŒè´£**: èŠ‚ç‚¹çš„åŸºç¡€æ“ä½œ
- **ä»£ç è¡Œæ•°**: ~325 è¡Œ
- **è¯„ä¼°**:
  - ä¸ CanvasNodeManager çš„å…³ç³»
  - æ˜¯å¦éœ€è¦åˆå¹¶æˆ–é‡æ–°åˆ’åˆ†èŒè´£

---

## é‡æ„ç»Ÿè®¡

| æ–‡ä»¶ | åŸå§‹è¡Œæ•° | å½“å‰çŠ¶æ€ | å¤‡æ³¨ |
|------|----------|----------|------|
| canvas-manager.ts | ~632 | âœ… å®Œæˆ | å·²ç˜¦èº«ï¼ŒèŒè´£æ¸…æ™° |
| canvas-event-manager.ts | ~841 | âœ… å®Œæˆ | æ–°æå–çš„æ¨¡å— |
| floating-node-manager.ts | ~711 | âœ… å®Œæˆ | æ–°æå–çš„æ¨¡å— |
| layout-manager.ts | ~863 | ğŸ”„ è¿›è¡Œä¸­ | éœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ– |
| canvas-node-manager.ts | ~533 | â³ å¾…å¼€å§‹ | å¾…é‡æ„ |
| canvas-ui-manager.ts | ~338 | â³ å¾…å¼€å§‹ | å¾…é‡æ„ |
| edge-manager.ts | ~335 | â³ å¾…è¯„ä¼° | è¯„ä¼°ä¸­ |
| node-manager.ts | ~325 | â³ å¾…è¯„ä¼° | è¯„ä¼°ä¸­ |
| **æ€»è®¡** | **~4578** | - | - |

---

## æœ€è¿‘ä¿®å¤çš„é—®é¢˜

### 2026-02-06 æµ®åŠ¨èŠ‚ç‚¹é‡è¿æ ·å¼ä¸å¸ƒå±€ä¼˜åŒ–

**ä¿®å¤é—®é¢˜ï¼š**
1.  **é‡è¿åçº¢æ¡†ä¸æ¶ˆå¤±**ï¼šç”±äº Obsidian å¼‚æ­¥ä¿å­˜æœºåˆ¶ï¼Œæ–°è¿çš„è¾¹å¯èƒ½å°šæœªå†™å…¥æ–‡ä»¶ã€‚é‡æ„ `LayoutDataProvider` å¢åŠ å¯¹å†…å­˜ä¸­è¾¹çš„å³æ—¶æ ¡éªŒï¼Œç¡®ä¿è¿çº¿åå³ä½¿æ–‡ä»¶æœªä¿å­˜ä¹Ÿèƒ½ç«‹å³è¯†åˆ«å¹¶æ¸…é™¤æµ®åŠ¨çŠ¶æ€ã€‚
2.  **å¸ƒå±€ä½ç½®å¼‚å¸¸**ï¼šä¿®å¤äº†æµ®åŠ¨èŠ‚ç‚¹åœ¨å¸ƒå±€æ—¶æ€»æ˜¯è¢«å¼ºåˆ¶æ’å…¥åˆ°çˆ¶èŠ‚ç‚¹å­èŠ‚ç‚¹åˆ—è¡¨æœ€å‰ç«¯çš„é—®é¢˜ã€‚ç°åœ¨æµ®åŠ¨èŠ‚ç‚¹ä¼šæ ¹æ® `originalEdges` ä¸­çš„ç›¸å¯¹é¡ºåºï¼Œæ’å…¥åˆ°æ­£ç¡®çš„ä½ç½®ï¼Œä¿æŒå¸ƒå±€çš„è¿ç»­æ€§ã€‚

**æŠ€æœ¯æ”¹åŠ¨ï¼š**
- [layout-data-provider.ts](file:///Users/apple/Develop/canvas-mindmap-build/src/canvas/services/layout-data-provider.ts): `getValidatedFloatingNodes` å¢åŠ  `memoryEdges` å‚æ•°ï¼Œå®ç°åŒé‡æ ¡éªŒã€‚
- [layout.ts](file:///Users/apple/Develop/canvas-mindmap-build/src/canvas/layout.ts): æ”¹è¿›è™šæ‹Ÿè¾¹æ’å…¥é€»è¾‘ï¼Œé€šè¿‡ `completeChildrenMap` è®¡ç®—ç›¸å¯¹åºå·è¿›è¡Œç²¾ç¡®ä½ç½®æ’å…¥ã€‚
- [layout.ts](file:///Users/apple/Develop/canvas-mindmap-build/src/canvas/layout.ts): å¢åŠ æ ¹èŠ‚ç‚¹æ’åºé€»è¾‘ï¼Œå¢å¼ºå¸ƒå±€ç¨³å®šæ€§ã€‚

### 2026-02-06: æµ®åŠ¨èŠ‚ç‚¹çº¢æ¡†æ˜¾ç¤ºä¸è¿çº¿é€»è¾‘ä¼˜åŒ–

**é—®é¢˜æè¿°**:
- åˆ é™¤è¾¹åï¼Œæµ®åŠ¨èŠ‚ç‚¹æœ‰æ—¶ä¸æ˜¾ç¤ºçº¢æ¡†ï¼Œæˆ–è€…çº¢æ¡†åœ¨ç¼©æ”¾åæ¶ˆå¤±ã€‚
- ç»™æµ®åŠ¨èŠ‚ç‚¹è¿æ¥æ–°è¾¹æ—¶ï¼Œéœ€è¦è¿ä¸¤æ¬¡æ‰èƒ½æˆåŠŸã€‚
- é‡æ–°è¿çº¿åï¼Œçº¢æ¡†æ ·å¼æ®‹ç•™ï¼Œä¸ä¼šç«‹å³æ¶ˆå¤±ã€‚

**æ ¹æœ¬åŸå› **:
1. **DOM é‡ç»˜**: Obsidian åœ¨ç¼©æ”¾æˆ–åˆ é™¤æ“ä½œæ—¶ä¼šé‡ç»˜èŠ‚ç‚¹ï¼Œå¯¼è‡´æ‰‹åŠ¨æ·»åŠ çš„æ ·å¼ç±»ä¸¢å¤±ã€‚
2. **æ–‡ä»¶å†™å…¥å†²çª**: é¢‘ç¹çš„åŸå­åŒ–æ–‡ä»¶å†™å…¥ä¸ Obsidian åŸç”Ÿä¿å­˜æœºåˆ¶å†²çªï¼Œå¯¼è‡´ç¬¬ä¸€æ¬¡è¿çº¿è¢«å›æ»šã€‚
3. **äº‹ä»¶ä¸¢å¤±**: `canvas:edge-created` äº‹ä»¶åœ¨æŸäº›æƒ…å†µä¸‹æœªè§¦å‘ï¼Œå¯¼è‡´æ¸…ç†é€»è¾‘æœªè¿è¡Œã€‚

**è§£å†³æ–¹æ¡ˆ**:
1. **æ ·å¼å¢å¼º**: ä½¿ç”¨ `MutationObserver` ç›‘å¬ DOM å˜åŒ–å¹¶è‡ªåŠ¨é‡è¡¥æ ·å¼ï¼›å¢åŠ å¤šçº§å»¶è¿Ÿé‡è¯•æœºåˆ¶ã€‚
2. **çŠ¶æ€ä¼˜å…ˆ**: ä¼˜å…ˆæ›´æ–°å†…å­˜ä¸­çš„ `node.data.isFloating`ï¼Œç§»é™¤å†²çªçš„åŸå­æ–‡ä»¶å†™å…¥ã€‚
3. **å…¨é‡äº‹ä»¶ç›‘å¬**: å¢åŠ  `edge-add` äº‹ä»¶ç›‘å¬ï¼Œç¡®ä¿ä»»ä½•è¿çº¿æ“ä½œéƒ½èƒ½å³æ—¶è§¦å‘çŠ¶æ€æ¸…é™¤ã€‚
4. **è§†è§‰ä¼˜åŒ–**: ä½¿ç”¨ `!important` å’Œå¼ºåˆ¶é‡ç»˜ç¡®ä¿æ ·å¼å³æ—¶ç”Ÿæ•ˆå¹¶æŒä¹…æ˜¾ç¤ºã€‚

**ä¿®æ”¹çš„æ–‡ä»¶**:
- `src/canvas/canvas-event-manager.ts`
- `src/canvas/services/floating-node-service.ts`
- `src/canvas/services/floating-node-style-manager.ts`
- `src/canvas/services/edge-change-detector.ts`

---

## ä¸‹ä¸€æ­¥è®¡åˆ’

### çŸ­æœŸç›®æ ‡ (1-2 å‘¨)
1. å®Œæˆ LayoutManager çš„ä¼˜åŒ–
2. è¯„ä¼° EdgeManager å’Œ NodeManager æ˜¯å¦éœ€è¦é‡æ„
3. ä¿®å¤é‡æ„è¿‡ç¨‹ä¸­å‘ç°çš„ bug

### ä¸­æœŸç›®æ ‡ (1 ä¸ªæœˆ)
1. é‡æ„ CanvasNodeManager
2. é‡æ„ CanvasUIManager
3. å®Œå–„å•å…ƒæµ‹è¯•

### é•¿æœŸç›®æ ‡ (2-3 ä¸ªæœˆ)
1. ä¼˜åŒ–æ€§èƒ½ï¼Œç¡®ä¿å¸ƒå±€ 100 ä¸ªèŠ‚ç‚¹ < 100ms
2. æ·»åŠ æ›´å¤šè‡ªåŠ¨åŒ–æµ‹è¯•
3. å®Œå–„æ–‡æ¡£å’Œæ³¨é‡Š

---

## é‡æ„æœ€ä½³å®è·µ

### 1. ä¿æŒå…¼å®¹æ€§
- æ–°æ—§æ ¼å¼åŒæ—¶å†™å…¥ï¼Œè¯»å–æ—¶ä¼˜å…ˆæ–°æ ¼å¼
- å…¬å¼€ API çš„ç­¾åä¿æŒä¸å˜
- ç¡®ä¿æ–°ä»£ç èƒ½å¤„ç†æ—§æ•°æ®

### 2. ä»£ç è´¨é‡
- æ¯ä¸ª Manager èŒè´£å•ä¸€
- å‡½æ•°é•¿åº¦æ§åˆ¶åœ¨ 50 è¡Œä»¥å†…
- æ·»åŠ å¿…è¦çš„æ³¨é‡Šå’Œæ–‡æ¡£

### 3. æµ‹è¯•ç­–ç•¥
- é‡æ„å‰ç¡®ä¿åŠŸèƒ½æ­£å¸¸
- é‡æ„åéªŒè¯åŠŸèƒ½æœªå—å½±å“
- æ·»åŠ å•å…ƒæµ‹è¯•è¦†ç›–æ ¸å¿ƒåŠŸèƒ½

---

## å‚è€ƒæ–‡æ¡£

- [æŠ€æœ¯å®ç°ç»éªŒæ€»ç»“](./TECHNICAL_NOTES.md)
- [ç”Ÿäº§ç‰ˆæœ¬ä¼˜åŒ–è®¡åˆ’](./.trae/documents/Canvas%20Mindmap%20Build%20æ’ä»¶ç”Ÿäº§ç‰ˆæœ¬ä¼˜åŒ–è®¡åˆ’.md)
- [README](./README.md)

---

*æœ€åæ›´æ–°: 2026-02-06*
*ç‰ˆæœ¬: 1.2.0*
